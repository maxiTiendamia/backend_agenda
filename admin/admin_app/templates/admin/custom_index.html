{% extends admin_base_template %} {% block body %}
<div class="container mt-4">
  <h2>ðŸ“Š Panel de control</h2>

  <div class="row mt-4">
    <div class="col-md-4">
      <div class="card text-bg-light mb-3 shadow-sm">
        <div class="card-header">Total de clientes</div>
        <div class="card-body">
          <h3 class="card-title">{{ total_clientes }}</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-4 shadow-sm">
    <div class="card-header">ðŸŸ¢ Estado de sesiones Venom</div>
    <div class="card-body">
      {% if estado_sesiones.error %}
      <p class="text-danger">
        Error al consultar Venom: {{ estado_sesiones.error }}
      </p>
      {% else %}
      <ul>
        {% for session_id, estado in estado_sesiones.items() %}
        <li><strong>Cliente {{ session_id }}:</strong> {{ estado }}</li>
        {% endfor %}
      </ul>
      {% endif %}
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">ðŸ§¾ Ãšltimos clientes registrados</div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Comercio</th>
                <th>TelÃ©fono</th>
                <th>Creado</th>
              </tr>
            </thead>
            <tbody>
              {% for cliente in ultimos_clientes %}
              <tr>
                <td>{{ cliente.nombre }} {{ cliente.apellido }}</td>
                <td>{{ cliente.comercio or "â€”" }}</td>
                <td>{{ cliente.telefono }}</td>
                <td>{{ cliente.fecha_creada.strftime('%d/%m/%Y') }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4">Sin clientes aÃºn.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">
          ðŸš¨ Ãšltimos errores registrados ({{ total_errores }})
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>TelÃ©fono</th>
                <th>Mensaje</th>
                <th>Fecha</th>
                <th>Ver</th>
              </tr>
            </thead>
            <tbody>
              {% for error in errores %}
              <tr>
                <td>{{ error.id }}</td>
                <td>{{ error.cliente or "â€”" }}</td>
                <td>{{ error.telefono or "â€”" }}</td>
                <td>
                  {{ error.mensaje[:40] ~ ("..." if error.mensaje and
                  error.mensaje|length > 40 else "") }}
                </td>
                <td>
                  {{ error.fecha.strftime('%d/%m/%Y %H:%M') if error.fecha else
                  "" }}
                </td>
                <td>
                  <a
                    href="/admin/errorlog/details/?id={{ error.id }}"
                    class="btn btn-sm btn-outline-info"
                    >Ver</a
                  >
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6">Sin errores recientes.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <a href="/admin/errorlog/" class="btn btn-danger"
            >Ver todos los errores</a
          >
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">ðŸ“– Historial de reservas recientes</div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Empleado</th>
                <th>Servicio</th>
                <th>Fecha</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for reserva in reservas %}
              <tr>
                <td>{{ reserva.fake_id }}</td>
                <td>{{ reserva.cliente_nombre }}</td>
                <td>{{ reserva.empleado_nombre }}</td>
                <td>{{ reserva.servicio }}</td>
                <td>{{ reserva.fecha_reserva.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{{ reserva.estado }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6">Sin reservas aÃºn.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <a href="/admin/reserva/" class="btn btn-primary"
            >Ver historial completo y filtrar</a
          >
        </div>
      </div>
    </div>
  </div>

  <!-- GrÃ¡fico y exportaciÃ³n CSV de reservas por estado -->
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm mb-4">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <span>ðŸ“ˆ Reservas por estado (filtradas)</span>
          <button id="export-btn" class="btn btn-sm btn-success">
            Exportar CSV
          </button>
        </div>
        <div class="card-body">
          <canvas id="reservasChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ObtÃ©n los datos de la tabla filtrada
  function getChartData() {
    const estados = {};
    document.querySelectorAll("table tbody tr").forEach((row) => {
      const estado = row.querySelector("td:last-child");
      if (estado) {
        const val = estado.textContent.trim();
        if (val) estados[val] = (estados[val] || 0) + 1;
      }
    });
    return {
      labels: Object.keys(estados),
      data: Object.values(estados),
    };
  }

  function renderChart() {
    const chartData = getChartData();
    if (window.reservasChart) window.reservasChart.destroy();
    const ctx = document.getElementById("reservasChart").getContext("2d");
    window.reservasChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: chartData.labels,
        datasets: [
          {
            data: chartData.data,
            backgroundColor: [
              "#4caf50",
              "#f44336",
              "#ff9800",
              "#2196f3",
              "#9c27b0",
              "#03a9f4",
            ],
          },
        ],
      },
    });
  }

  // Exportar tabla filtrada a CSV
  document.getElementById("export-btn").onclick = function () {
    let csv = "";
    document.querySelectorAll("table thead tr").forEach((row) => {
      csv +=
        Array.from(row.children)
          .map((td) => `"${td.textContent.trim()}"`)
          .join(",") + "\n";
    });
    document.querySelectorAll("table tbody tr").forEach((row) => {
      csv +=
        Array.from(row.children)
          .map((td) => `"${td.textContent.trim()}"`)
          .join(",") + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "reservas_filtradas.csv";
    a.click();
    URL.revokeObjectURL(url);
  };

  // Renderiza la grÃ¡fica al cargar y al filtrar
  renderChart();
  // Observa cambios en la tabla (por filtros)
  const observer = new MutationObserver(renderChart);
  observer.observe(document.querySelector("table tbody"), {
    childList: true,
    subtree: true,
  });
</script>
{% endblock %}
