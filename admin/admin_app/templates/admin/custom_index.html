{% extends admin_base_template %} {% block body %}
<div class="container mt-4">
  <h2>📊 Panel de control</h2>

  <div class="row mt-4">
    <div class="col-md-4">
      <div class="card text-bg-light mb-3 shadow-sm">
        <div class="card-header">Total de clientes</div>
        <div class="card-body">
          <h3 class="card-title">{{ total_clientes }}</h3>
        </div>
      </div>
    </div>
  </div>

  <h4>📡 Estado de Sesiones Activas</h4>
  <table class="table table-sm table-bordered">
    <thead class="thead-light">
      <tr>
        <th>Cliente ID</th>
        <th>Nombre</th>
        <th>Comercio</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% if estado_sesiones is iterable %} {% for sesion in estado_sesiones %}
      <tr>
        <td>{{ sesion.clienteId }}</td>
        <td>{{ sesion.nombre or "—" }}</td>
        <td>{{ sesion.comercio or "—" }}</td>
        <td>
          {% set estado = sesion.estado %} {% if estado == 'CONNECTED' %}
          <span style="color: green">🟢 Conectado</span>
          {% elif estado == 'DISCONNECTED' %}
          <span style="color: red">🔴 Desconectado</span>
          {% elif estado == 'TIMEOUT' %}
          <span style="color: orange">🟠 Timeout</span>
          {% elif estado == 'NO_INICIADA' %}
          <span style="color: gray">⚪ No iniciada</span>
          {% elif estado == 'ERROR' %}
          <span style="color: darkred">❌ Error</span>
          {% elif estado == 'ARCHIVOS_DISPONIBLES' %}
          <span style="color: blue">💾 Archivos disponibles</span>
          {% elif estado == 'UNPAIRED' %}
          <span style="color: red">🔴 No emparejado</span>
          {% elif estado == 'UNLAUNCHED' %}
          <span style="color: red">🔴 No lanzado</span>
          {% else %}
          <span style="color: gray">⚪ {{ estado }}</span>
          {% endif %}
          
          {% if sesion.enMemoria %}
          <small style="color: #666;">(En memoria)</small>
          {% endif %}
          {% if sesion.tieneArchivos %}
          <small style="color: #666;">(Con archivos)</small>
          {% endif %}
        </td>
        <td>
          <a
            href="/admin/reiniciar/{{ sesion.clienteId }}"
            class="btn btn-sm btn-warning me-1"
            title="Regenerar QR manualmente"
          >
            🔄 Regenerar QR
          </a>
          {% if sesion.estado == 'ERROR' %}
          <a
            href="/admin/reset-errores/{{ sesion.clienteId }}"
            class="btn btn-sm btn-danger"
            title="Resetear contador de errores"
          >
            🔧 Reset Errores
          </a>
          {% endif %}
        </td>
      </tr>
      {% endfor %} {% else %}
      <tr>
        <td colspan="5">⚠️ No se pudieron obtener las sesiones activas.</td>
      </tr>
      {% endif %}
    </tbody>
  </table>

  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">🧾 Últimos clientes registrados</div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Comercio</th>
                <th>Teléfono</th>
                <th>Creado</th>
              </tr>
            </thead>
            <tbody>
              {% for cliente in ultimos_clientes %}
              <tr>
                <td>{{ cliente.nombre }} {{ cliente.apellido }}</td>
                <td>{{ cliente.comercio or "—" }}</td>
                <td>{{ cliente.telefono }}</td>
                <td>{{ cliente.fecha_creada.strftime('%d/%m/%Y') }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="4">Sin clientes aún.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">
          🚨 Últimos errores registrados ({{ total_errores }})
        </div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Teléfono</th>
                <th>Mensaje</th>
                <th>Fecha</th>
                <th>Ver</th>
              </tr>
            </thead>
            <tbody>
              {% for error in errores %}
              <tr>
                <td>{{ error.id }}</td>
                <td>{{ error.cliente or "—" }}</td>
                <td>{{ error.telefono or "—" }}</td>
                <td>
                  {{ error.mensaje[:40] ~ ("..." if error.mensaje and
                  error.mensaje|length > 40 else "") }}
                </td>
                <td>
                  {{ error.fecha.strftime('%d/%m/%Y %H:%M') if error.fecha else
                  "" }}
                </td>
                <td>
                  <a
                    href="/admin/errorlog/details/?id={{ error.id }}"
                    class="btn btn-sm btn-outline-info"
                    >Ver</a
                  >
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6">Sin errores recientes.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <a href="/admin/errorlog/" class="btn btn-danger"
            >Ver todos los errores</a
          >
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm">
        <div class="card-header">📖 Historial de reservas recientes</div>
        <div class="card-body">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Empleado</th>
                <th>Servicio</th>
                <th>Fecha</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              {% for reserva in reservas %}
              <tr>
                <td>{{ reserva.fake_id }}</td>
                <td>{{ reserva.cliente_nombre }}</td>
                <td>{{ reserva.empleado_nombre }}</td>
                <td>{{ reserva.servicio }}</td>
                <td>{{ reserva.fecha_reserva.strftime('%d/%m/%Y %H:%M') }}</td>
                <td>{{ reserva.estado }}</td>
              </tr>
              {% else %}
              <tr>
                <td colspan="6">Sin reservas aún.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          <a href="/admin/reserva/" class="btn btn-primary"
            >Ver historial completo y filtrar</a
          >
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm mb-4">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <span>📈 Reservas por estado (filtradas)</span>
          <button id="export-btn" class="btn btn-sm btn-success">
            Exportar CSV
          </button>
        </div>
        <div class="card-body">
          <canvas id="reservasChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Nueva sección para mostrar información de errores de sesión -->
  {% if errores_sesion and errores_sesion.session_errors %}
  <div class="row mt-4">
    <div class="col-md-12">
      <div class="card shadow-sm border-warning">
        <div class="card-header bg-warning text-dark">
          ⚠️ Información de errores de sesión ({{ errores_sesion.total_clientes_con_errores }} clientes)
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Cliente ID</th>
                  <th>Errores consecutivos</th>
                  <th>Estado</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody>
                {% for cliente_id, count in errores_sesion.session_errors.items() %}
                <tr>
                  <td>{{ cliente_id }}</td>
                  <td>
                    <span class="badge {% if count >= 5 %}bg-danger{% elif count >= 3 %}bg-warning{% else %}bg-secondary{% endif %}">
                      {{ count }}
                    </span>
                  </td>
                  <td>
                    {% if count >= 5 %}
                    <span class="text-danger">🚫 Bloqueado</span>
                    {% else %}
                    <span class="text-success">✅ Activo</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if count >= 3 %}
                    <a
                      href="/admin/reset-errores/{{ cliente_id }}"
                      class="btn btn-sm btn-outline-danger"
                      title="Resetear contador de errores"
                    >
                      🔧 Reset
                    </a>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if errores_sesion.clientes_bloqueados %}
          <div class="mt-3">
            <h6 class="text-danger">🚫 Clientes bloqueados:</h6>
            <ul class="list-unstyled">
              {% for cliente in errores_sesion.clientes_bloqueados %}
              <li class="text-danger">
                Cliente {{ cliente.clienteId }}: {{ cliente.errores }} errores consecutivos
                <a href="/admin/reset-errores/{{ cliente.clienteId }}" class="btn btn-sm btn-outline-danger ms-2">🔧 Reset</a>
              </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  function getChartData() {
    const estados = {};
    document.querySelectorAll("table tbody tr").forEach((row) => {
      const estado = row.querySelector("td:last-child");
      if (estado) {
        const val = estado.textContent.trim();
        if (val) estados[val] = (estados[val] || 0) + 1;
      }
    });
    return {
      labels: Object.keys(estados),
      data: Object.values(estados),
    };
  }

  function renderChart() {
    const chartData = getChartData();
    if (window.reservasChart) window.reservasChart.destroy();
    const ctx = document.getElementById("reservasChart").getContext("2d");
    window.reservasChart = new Chart(ctx, {
      type: "pie",
      data: {
        labels: chartData.labels,
        datasets: [
          {
            data: chartData.data,
            backgroundColor: [
              "#4caf50",
              "#f44336",
              "#ff9800",
              "#2196f3",
              "#9c27b0",
              "#03a9f4",
            ],
          },
        ],
      },
    });
  }

  document.getElementById("export-btn").onclick = function () {
    let csv = "";
    document.querySelectorAll("table thead tr").forEach((row) => {
      csv +=
        Array.from(row.children)
          .map((td) => `"${td.textContent.trim()}"`)
          .join(",") + "\n";
    });
    document.querySelectorAll("table tbody tr").forEach((row) => {
      csv +=
        Array.from(row.children)
          .map((td) => `"${td.textContent.trim()}"`)
          .join(",") + "\n";
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "reservas_filtradas.csv";
    a.click();
    URL.revokeObjectURL(url);
  };

  renderChart();
  const observer = new MutationObserver(renderChart);
  observer.observe(document.querySelector("table tbody"), {
    childList: true,
    subtree: true,
  });
</script>
{% endblock %}
